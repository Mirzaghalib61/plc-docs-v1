{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sunil/PLC%20User%20Guide%20App/plc-docs-poc/lib/document-generator-template.ts"],"sourcesContent":["import * as fs from 'fs'\r\nimport * as path from 'path'\r\nconst PizZip = require('pizzip')\r\nconst Docxtemplater = require('docxtemplater')\r\n\r\ninterface InterviewData {\r\n  id: string\r\n  sme_name: string\r\n  sme_title: string\r\n  equipment_name: string\r\n  equipment_location: string\r\n  current_phase: number\r\n  status: string\r\n  conversation_history: ConversationEntry[]\r\n  created_at: string\r\n  updated_at: string\r\n}\r\n\r\ninterface ConversationEntry {\r\n  timestamp: string\r\n  text: string\r\n  phase: number\r\n  speaker: 'AI' | 'SME' | 'SYSTEM'\r\n}\r\n\r\ninterface ExtractedData {\r\n  // Quick Start\r\n  quirks: Array<{title: string, symptom: string, root_cause: string, dont: string, do: string}>\r\n  phantom_faults: string\r\n  optimal_range: string\r\n  sweet_spot: string\r\n  when_to_adjust: string\r\n  avoidable_causes: string[]\r\n  \r\n  // Safety\r\n  hazards: string\r\n  estop_locations: string\r\n  safety_gates: string\r\n  ppe_requirements: string\r\n  stop_work_triggers: string\r\n  \r\n  // System Overview\r\n  system_purpose: string\r\n  products: string\r\n  operating_schedule: string\r\n  throughput: string\r\n  quality_requirements: string\r\n  why_critical: string\r\n  downtime_impact: string\r\n  \r\n  // Technical\r\n  plc_info: string\r\n  io_info: string\r\n  hmi_info: string\r\n  drives_info: string\r\n  safety_chain: string\r\n  instrumentation: string\r\n  utilities: string\r\n  networks: string\r\n  \r\n  // Procedures\r\n  startup_procedure: string[]\r\n  normal_operation: string[]\r\n  shutdown_procedure: string[]\r\n  \r\n  // Common Problems\r\n  common_problems: Array<{\r\n    code: string\r\n    trigger: string\r\n    causes: string\r\n    operator_actions: string\r\n    maintenance_actions: string\r\n    downtime_risk: string\r\n    notes: string\r\n  }>\r\n  \r\n  // Skipped sections\r\n  skipped_sections: string[]\r\n}\r\n\r\n/**\r\n * Extract structured data from conversation history using AI\r\n */\r\nasync function extractStructuredData(interview: InterviewData): Promise<ExtractedData> {\r\n  // Combine all SME responses\r\n  const smeResponses = interview.conversation_history\r\n    .filter(entry => entry.speaker === 'SME')\r\n    .map(entry => entry.text)\r\n    .join('\\n\\n')\r\n  \r\n  // Use Claude to extract structured data\r\n  const Anthropic = require('@anthropic-ai/sdk')\r\n  const anthropic = new Anthropic({\r\n    apiKey: process.env.ANTHROPIC_API_KEY,\r\n  })\r\n  \r\n  const extractionPrompt = `Analyze this equipment interview transcript and extract structured data for a PLC operations manual.\r\n\r\nEquipment: ${interview.equipment_name}\r\nLocation: ${interview.equipment_location}\r\nSME: ${interview.sme_name}, ${interview.sme_title}\r\n\r\nTRANSCRIPT:\r\n${smeResponses}\r\n\r\nExtract the following information in JSON format. If information is not mentioned, use \"[NOT COVERED IN INTERVIEW]\":\r\n\r\n{\r\n  \"quirks\": [{\"title\": \"...\", \"symptom\": \"...\", \"root_cause\": \"...\", \"dont\": \"...\", \"do\": \"...\"}],\r\n  \"phantom_faults\": \"...\",\r\n  \"optimal_range\": \"...\",\r\n  \"sweet_spot\": \"...\",\r\n  \"when_to_adjust\": \"...\",\r\n  \"avoidable_causes\": [\"cause 1\", \"cause 2\", \"cause 3\"],\r\n  \"hazards\": \"...\",\r\n  \"estop_locations\": \"...\",\r\n  \"safety_gates\": \"...\",\r\n  \"ppe_requirements\": \"...\",\r\n  \"stop_work_triggers\": \"...\",\r\n  \"system_purpose\": \"...\",\r\n  \"products\": \"...\",\r\n  \"operating_schedule\": \"...\",\r\n  \"throughput\": \"...\",\r\n  \"quality_requirements\": \"...\",\r\n  \"why_critical\": \"...\",\r\n  \"downtime_impact\": \"...\",\r\n  \"plc_info\": \"...\",\r\n  \"io_info\": \"...\",\r\n  \"hmi_info\": \"...\",\r\n  \"drives_info\": \"...\",\r\n  \"safety_chain\": \"...\",\r\n  \"instrumentation\": \"...\",\r\n  \"utilities\": \"...\",\r\n  \"networks\": \"...\",\r\n  \"startup_procedure\": [\"step 1\", \"step 2\"],\r\n  \"normal_operation\": [\"step 1\", \"step 2\"],\r\n  \"shutdown_procedure\": [\"step 1\", \"step 2\"],\r\n  \"common_problems\": [\r\n    {\r\n      \"code\": \"alarm code or description\",\r\n      \"trigger\": \"what triggers it\",\r\n      \"causes\": \"likely causes\",\r\n      \"operator_actions\": \"what operator should do\",\r\n      \"maintenance_actions\": \"what maintenance should do\",\r\n      \"downtime_risk\": \"low/medium/high\",\r\n      \"notes\": \"any quirks or notes\"\r\n    }\r\n  ],\r\n  \"skipped_sections\": [\"section name if not covered\"]\r\n}\r\n\r\nReturn ONLY the JSON, no markdown or explanation.`\r\n\r\n  try {\r\n    const response = await anthropic.messages.create({\r\n      model: 'claude-sonnet-4-20250514',\r\n      max_tokens: 8192,\r\n      messages: [{\r\n        role: 'user',\r\n        content: extractionPrompt\r\n      }]\r\n    })\r\n    \r\n    const content = response.content[0].text\r\n    \r\n    // Try to extract JSON from response\r\n    let jsonMatch = content.match(/\\{[\\s\\S]*\\}/)\r\n    \r\n    if (!jsonMatch) {\r\n      // Try removing markdown code blocks\r\n      const cleanContent = content.replace(/```json\\n?/g, '').replace(/```\\n?/g, '')\r\n      jsonMatch = cleanContent.match(/\\{[\\s\\S]*\\}/)\r\n    }\r\n    \r\n    if (!jsonMatch) {\r\n      throw new Error('Failed to extract JSON from AI response')\r\n    }\r\n    \r\n    const parsed = JSON.parse(jsonMatch[0])\r\n    \r\n    // Ensure arrays are actually arrays\r\n    if (!Array.isArray(parsed.quirks)) parsed.quirks = []\r\n    if (!Array.isArray(parsed.avoidable_causes)) parsed.avoidable_causes = []\r\n    if (!Array.isArray(parsed.startup_procedure)) parsed.startup_procedure = []\r\n    if (!Array.isArray(parsed.normal_operation)) parsed.normal_operation = []\r\n    if (!Array.isArray(parsed.shutdown_procedure)) parsed.shutdown_procedure = []\r\n    if (!Array.isArray(parsed.common_problems)) parsed.common_problems = []\r\n    if (!Array.isArray(parsed.skipped_sections)) parsed.skipped_sections = []\r\n    \r\n    return parsed\r\n  } catch (error) {\r\n    console.error('AI extraction error:', error)\r\n    // Return default structure with \"not covered\" placeholders\r\n    return getDefaultExtractedData()\r\n  }\r\n}\r\n\r\nfunction getDefaultExtractedData(): ExtractedData {\r\n  return {\r\n    quirks: [],\r\n    phantom_faults: '[NOT COVERED IN INTERVIEW]',\r\n    optimal_range: '[NOT COVERED IN INTERVIEW]',\r\n    sweet_spot: '[NOT COVERED IN INTERVIEW]',\r\n    when_to_adjust: '[NOT COVERED IN INTERVIEW]',\r\n    avoidable_causes: [],\r\n    hazards: '[NOT COVERED IN INTERVIEW]',\r\n    estop_locations: '[NOT COVERED IN INTERVIEW]',\r\n    safety_gates: '[NOT COVERED IN INTERVIEW]',\r\n    ppe_requirements: '[NOT COVERED IN INTERVIEW]',\r\n    stop_work_triggers: '[NOT COVERED IN INTERVIEW]',\r\n    system_purpose: '[NOT COVERED IN INTERVIEW]',\r\n    products: '[NOT COVERED IN INTERVIEW]',\r\n    operating_schedule: '[NOT COVERED IN INTERVIEW]',\r\n    throughput: '[NOT COVERED IN INTERVIEW]',\r\n    quality_requirements: '[NOT COVERED IN INTERVIEW]',\r\n    why_critical: '[NOT COVERED IN INTERVIEW]',\r\n    downtime_impact: '[NOT COVERED IN INTERVIEW]',\r\n    plc_info: '[NOT COVERED IN INTERVIEW]',\r\n    io_info: '[NOT COVERED IN INTERVIEW]',\r\n    hmi_info: '[NOT COVERED IN INTERVIEW]',\r\n    drives_info: '[NOT COVERED IN INTERVIEW]',\r\n    safety_chain: '[NOT COVERED IN INTERVIEW]',\r\n    instrumentation: '[NOT COVERED IN INTERVIEW]',\r\n    utilities: '[NOT COVERED IN INTERVIEW]',\r\n    networks: '[NOT COVERED IN INTERVIEW]',\r\n    startup_procedure: [],\r\n    normal_operation: [],\r\n    shutdown_procedure: [],\r\n    common_problems: [],\r\n    skipped_sections: ['Most sections not covered - interview incomplete']\r\n  }\r\n}\r\n\r\n/**\r\n * Get all placeholders from template\r\n */\r\nfunction getAllPlaceholders(template: Buffer): string[] {\r\n  const content = template.toString('utf8')\r\n  const placeholders = new Set<string>()\r\n  \r\n  // Match {{PLACEHOLDER}} patterns\r\n  const regex = /\\{\\{([A-Z_0-9.]+)\\}\\}/g\r\n  let match\r\n  \r\n  while ((match = regex.exec(content)) !== null) {\r\n    placeholders.add(match[1])\r\n  }\r\n  \r\n  return Array.from(placeholders)\r\n}\r\n\r\n/**\r\n * Generate document from template\r\n */\r\nexport async function generateDocumentFromTemplate(interview: InterviewData): Promise<Buffer> {\r\n  console.log('Starting document generation from template...')\r\n  \r\n  // Load template - try custom first, then default\r\n  const customTemplatePath = path.join(process.cwd(), 'templates', 'PLC_Operations_Manual_Template.docx')\r\n  const defaultTemplatePath = '/mnt/user-data/uploads/PLC_Operations_Manual_Template_WordReady_v2.docx'\r\n  \r\n  let templatePath = defaultTemplatePath\r\n  if (fs.existsSync(customTemplatePath)) {\r\n    templatePath = customTemplatePath\r\n    console.log('Using custom template')\r\n  } else {\r\n    console.log('Using default template')\r\n  }\r\n  \r\n  const template = fs.readFileSync(templatePath)\r\n  \r\n  // Get all placeholders from template\r\n  const placeholders = getAllPlaceholders(template)\r\n  console.log('Found placeholders in template:', placeholders.length)\r\n  \r\n  // Extract structured data from interview\r\n  console.log('Extracting structured data from interview...')\r\n  const data = await extractStructuredData(interview)\r\n  \r\n  // Create a comprehensive data object with ALL possible placeholders\r\n  const templateData: Record<string, string> = {}\r\n  \r\n  // Initialize all placeholders with default value\r\n  placeholders.forEach(placeholder => {\r\n    templateData[placeholder] = '[NOT COVERED IN INTERVIEW]'\r\n  })\r\n  \r\n  // Procedures - ensure they're arrays and format safely\r\n  const startupSteps = Array.isArray(data.startup_procedure) && data.startup_procedure.length > 0\r\n    ? data.startup_procedure.map((step, i) => `${i + 1}. ${step}`).join('\\n')\r\n    : '[NOT COVERED IN INTERVIEW]'\r\n\r\n  const normalOpSteps = Array.isArray(data.normal_operation) && data.normal_operation.length > 0\r\n    ? data.normal_operation.map((step, i) => `${i + 1}. ${step}`).join('\\n')\r\n    : '[NOT COVERED IN INTERVIEW]'\r\n\r\n  const shutdownSteps = Array.isArray(data.shutdown_procedure) && data.shutdown_procedure.length > 0\r\n    ? data.shutdown_procedure.map((step, i) => `${i + 1}. ${step}`).join('\\n')\r\n    : '[NOT COVERED IN INTERVIEW]'\r\n\r\n  const avoidableCauses = Array.isArray(data.avoidable_causes) && data.avoidable_causes.length > 0\r\n    ? data.avoidable_causes.join('; ')\r\n    : '[NOT COVERED IN INTERVIEW]'\r\n  \r\n  // Now override with actual data where available\r\n  Object.assign(templateData, {\r\n    GENERATED_DATE: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),\r\n    COMPANY_NAME: 'AI Documentation System',\r\n    SYSTEM_NAME: interview.equipment_name,\r\n    EQUIPMENT_LOCATION: interview.equipment_location,\r\n    SME_NAME: interview.sme_name,\r\n    SME_TITLE: interview.sme_title,\r\n    INTERVIEW_DATE: new Date(interview.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),\r\n    INTERVIEW_STATUS: interview.status === 'completed' ? 'Complete' : interview.status === 'terminated' ? 'Ended Early - Incomplete' : 'In Progress',\r\n    \r\n    // Quick Start - Critical Information\r\n    QUIRK_1_TITLE: data.quirks[0]?.title || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_1_SYMPTOM: data.quirks[0]?.symptom || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_1_ROOT_CAUSE: data.quirks[0]?.root_cause || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_1_DONT: data.quirks[0]?.dont || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_1_DO: data.quirks[0]?.do || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_2_TITLE: data.quirks[1]?.title || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_2_SYMPTOM: data.quirks[1]?.symptom || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_2_ROOT_CAUSE: data.quirks[1]?.root_cause || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_2_DONT: data.quirks[1]?.dont || '[NOT COVERED IN INTERVIEW]',\r\n    QUIRK_2_DO: data.quirks[1]?.do || '[NOT COVERED IN INTERVIEW]',\r\n    PHANTOM_FAULTS_LIST: data.phantom_faults,\r\n    OPTIMAL_RANGE_VALUE_UNITS: data.optimal_range,\r\n    SWEET_SPOT_SETPOINTS: data.sweet_spot,\r\n    WHEN_TO_ADJUST_AND_WHY: data.when_to_adjust,\r\n    TOP_5_AVOIDABLE_CAUSES: avoidableCauses,\r\n    \r\n    // Safety Essentials\r\n    PINCH_POINTS_HOT_SURFACES_ROTATING_ELECTRICAL_CHEMICALS: data.hazards,\r\n    ESTOP_LOCATIONS_AND_LABELS: data.estop_locations,\r\n    GATE_LOCATIONS_SWITCH_TYPES: data.safety_gates,\r\n    PPE_REQUIREMENTS: data.ppe_requirements,\r\n    STOP_WORK_TRIGGERS: data.stop_work_triggers,\r\n    \r\n    // System Overview\r\n    ONE_PARAGRAPH_PURPOSE_IN_PLAIN_LANGUAGE: data.system_purpose,\r\n    PRODUCT_LIST: data.products,\r\n    HOURS_PER_DAY_DAYS_PER_WEEK: data.operating_schedule,\r\n    UNITS_PER_MIN_HOUR_DAY: data.throughput,\r\n    'CRITICAL_LIMITS_E.G_TEMP_MOISTURE_WEIGHT_SEAL': data.quality_requirements,\r\n    DOWNSTREAM_UPSTREAM_DEPENDENCIES: data.why_critical,\r\n    MINUTES_BEFORE_LINE_STOP: data.downtime_impact,\r\n    COST_PER_HOUR: data.downtime_impact,\r\n    \r\n    // System Architecture\r\n    RACK_LAYOUT_CPU_FIRMWARE: data.plc_info,\r\n    REMOTE_IO_LOCATIONS_PROTOCOLS: data.io_info,\r\n    PANELVIEW_SCADA_CLIENT_LOCATIONS: data.hmi_info,\r\n    DRIVE_TYPES_NETWORK_CONTROL_MODE: data.drives_info,\r\n    SAFETY_CHAIN_DESCRIPTION_PERFORMANCE_LEVEL: data.safety_chain,\r\n    SENSOR_TYPES_COUNTS: data.instrumentation,\r\n    AIR_WATER_STEAM_CIP_POWER: data.utilities,\r\n    IP_SCHEME_VLANS_SWITCHES_FIREWALLS: data.networks,\r\n    \r\n    // Procedures - using the safe variables\r\n    STARTUP_STEPS: startupSteps,\r\n    NORMAL_OPERATION_STEPS: normalOpSteps,\r\n    SHUTDOWN_STEPS: shutdownSteps,\r\n    \r\n    // Skipped sections notice\r\n    SKIPPED_SECTIONS_NOTE: data.skipped_sections.length > 0 \r\n      ? `\\n\\n⚠️ NOTE: The following sections were not covered in this interview:\\n${data.skipped_sections.map(s => `- ${s}`).join('\\n')}\\n\\nThese sections should be completed in a follow-up interview or by technical documentation team.`\r\n      : '\\n\\n✓ All core sections were covered in this interview.',\r\n  })\r\n  \r\n  console.log('Loading template into docxtemplater...')\r\n  \r\n  // Load and process template\r\n  const zip = new PizZip(template)\r\n  \r\n  try {\r\n    const doc = new Docxtemplater(zip, {\r\n      paragraphLoop: true,\r\n      linebreaks: true,\r\n      nullGetter: (part: any) => {\r\n        console.log('Missing placeholder:', part.value)\r\n        return '[NOT COVERED IN INTERVIEW]'\r\n      },\r\n    })\r\n    \r\n    console.log('Rendering document with data...')\r\n    \r\n    // Render with data\r\n    doc.render(templateData)\r\n    \r\n    console.log('Generating final buffer...')\r\n    \r\n    // Generate buffer\r\n    const buffer = doc.getZip().generate({\r\n      type: 'nodebuffer',\r\n      compression: 'DEFLATE',\r\n    })\r\n    \r\n    console.log('Document generated successfully, size:', buffer.length)\r\n    \r\n    return buffer\r\n  } catch (error: any) {\r\n    console.error('Docxtemplater error:', error)\r\n    \r\n    if (error.properties && error.properties.errors) {\r\n      console.error('Template errors:', JSON.stringify(error.properties.errors, null, 2))\r\n    }\r\n    \r\n    throw error\r\n  }\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 352, "column": 0}, "map": {"version":3,"sources":["file:///C:/Sunil/PLC%20User%20Guide%20App/plc-docs-poc/app/api/interview/%5Bid%5D/generate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { createClient } from '@supabase/supabase-js'\r\nimport { generateDocumentFromTemplate } from '@/lib/document-generator-template'\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n)\r\n\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id: interviewId } = await params\r\n\r\n    console.log('Generate document API called for interview:', interviewId)\r\n\r\n    // Load interview from database\r\n    const { data: interview, error: fetchError } = await supabase\r\n      .from('interviews')\r\n      .select('*')\r\n      .eq('id', interviewId)\r\n      .single()\r\n\r\n    if (fetchError || !interview) {\r\n      console.error('Interview fetch error:', fetchError)\r\n      return NextResponse.json(\r\n        { error: 'Interview not found' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    console.log('Generating document for:', interview.equipment_name)\r\n\r\n    // Generate DOCX document using template\r\n    const documentBuffer = await generateDocumentFromTemplate(interview)\r\n\r\n    // Create filename\r\n    const filename = `${interview.equipment_name.replace(/[^a-z0-9]/gi, '_')}_Operations_Manual_${new Date().toISOString().split('T')[0]}.docx`\r\n\r\n    // Return file with proper headers\r\n    return new NextResponse(documentBuffer, {\r\n      status: 200,\r\n      headers: {\r\n        'Content-Type': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\r\n        'Content-Length': documentBuffer.length.toString(),\r\n      },\r\n    })\r\n\r\n  } catch (error: any) {\r\n    console.error('Document generation error:', error)\r\n\r\n    return NextResponse.json(\r\n      {\r\n        error: 'Failed to generate document',\r\n        details: error?.message || 'Unknown error occurred'\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\nexport const maxDuration = 60 // Increase timeout for AI extraction"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,MAAM,WAAW,IAAA,gMAAY,gFAE3B,QAAQ,GAAG,CAAC,yBAAyB;AAGhC,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,EAAE,IAAI,WAAW,EAAE,GAAG,MAAM;QAElC,QAAQ,GAAG,CAAC,+CAA+C;QAE3D,+BAA+B;QAC/B,MAAM,EAAE,MAAM,SAAS,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,cACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,aACT,MAAM;QAET,IAAI,cAAc,CAAC,WAAW;YAC5B,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsB,GAC/B;gBAAE,QAAQ;YAAI;QAElB;QAEA,QAAQ,GAAG,CAAC,4BAA4B,UAAU,cAAc;QAEhE,wCAAwC;QACxC,MAAM,iBAAiB,MAAM,IAAA,0KAA4B,EAAC;QAE1D,kBAAkB;QAClB,MAAM,WAAW,GAAG,UAAU,cAAc,CAAC,OAAO,CAAC,eAAe,KAAK,mBAAmB,EAAE,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC;QAE3I,kCAAkC;QAClC,OAAO,IAAI,gJAAY,CAAC,gBAAgB;YACtC,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,uBAAuB,CAAC,sBAAsB,EAAE,SAAS,CAAC,CAAC;gBAC3D,kBAAkB,eAAe,MAAM,CAAC,QAAQ;YAClD;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,8BAA8B;QAE5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS,OAAO,WAAW;QAC7B,GACA;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,MAAM,cAAc,GAAG,qCAAqC"}}]
}